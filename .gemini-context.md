# ðŸ¤– Gemini Context: local-nc-local-thumbnailer

## Project Overview
A Node.js worker that bridges the gap between a local FFmpeg installation and a remote Nextcloud instance. It scans WebDAV, generates thumbnails locally, and pushes them to the `nc-local-thumbnailer` app API.

## Core Logic
- **Directory Traversal**: Recursive scanning of WebDAV via `webdav` library.
- **Normalization**: All paths are normalized to have a leading slash to match Nextcloud internal pathing and ensure cache consistency.
- **FFmpeg**: Captures a screenshot at `00:00:02` with a width of `1024px`.

## Caching Strategy (3-Tier)
1. **Folder Cache (`folder_cache.csv`)**: Stores Unix timestamps of the last scan for folders that **contained no media**. Folders are skipped until the cooldown (default 7 days) expires.
2. **Thumb Cache (`thumb_cache.csv`)**: A Set of relative paths that have been successfully processed.
3. **Fail Cache (`fail_cache.csv`)**: Tracks files that FFmpeg or the API failed to process (e.g., 0-byte files) to prevent infinite retry loops.

## API Interaction
- Base URL: Derived from `NC_URL` (strips `/remote.php/...`).
- Endpoint: `index.php/apps/localthumbs/thumbnail`.
- Auth: Basic Auth using `NC_USER` and `NC_PASS`.

## Technical Tips for Gemini
- **Environment**: Supports `NODE_TLS_REJECT_UNAUTHORIZED=0` for local DDEV testing.
- **Pathing**: Always use `getRelativePath()` to convert full WebDAV URLs into Nextcloud-relative paths before caching or API calls.
