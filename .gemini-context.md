# ðŸ¤– Gemini Context: local-nc-local-thumbnailer

## Project Overview
A Node.js worker that bridges the gap between a local FFmpeg installation and a remote Nextcloud instance. It scans WebDAV, generates thumbnails locally, and pushes them to the `nc-local-thumbnailer` app API.

## Core Logic
-   **Directory Traversal**: Recursive scanning of WebDAV via `webdav` library.
-   **Sequential Queue**: A `JobQueue` ensures only one video is processed at a time.
-   **3-Stage Generation Strategy**:
    1.  **Remote Stream**: Direct `ffprobe`/`ffmpeg` execution against the WebDAV URL with Basic Auth headers and `-tls_verify 0`. Uses HTTP Range requests to extract thumbnails without full downloads.
    2.  **Partial Download**: Downloads first 100MB using `stream.pipeline` for "Fast Start" files.
    3.  **Full Fallback**: Only attempted if partial fails and file is within `MAX_VIDEO_SIZE_MB` (default 3000MB).
-   **FFmpeg Resource Control**: Threads limited via `FFMPEG_THREADS` or auto-detected (`Cores - 1`).
-   **Smart Timestamps**: Probes video duration first. Selects 50s/40s/30s/20s/10s/5s or 20% depending on length.

## Caching Strategy (3-Tier)
1.  **Folder Cache (`folder_cache.csv`)**: Stores timestamps of the last scan for folders without media.
2.  **Thumb Cache (`thumb_cache.csv`)**: Set of relative paths successfully processed.
3.  **Fail Cache (`fail_cache.csv`)**: Tracks files that failed processing.

*Note: All caches are ignored if `--force` flag is provided.*

## Reliability & Performance
-   **Spawn vs Exec**: Uses `child_process.spawn` for FFmpeg calls to safely handle special characters in passwords and URLs.
-   **Network Resilience**: Custom HTTP/HTTPS agents with `keepAlive: true`. Exponential backoff for download retries (5 attempts).
-   **Pathing**: All paths normalized to have a leading slash. Logs use full Nextcloud-relative paths.

## Technical Tips for Gemini
-   **Environment**: Supports `NODE_TLS_REJECT_UNAUTHORIZED=0`.
-   **API Interaction**: derivived from `NC_URL`. Endpoint: `index.php/apps/localthumbs/thumbnail`.
-   **Maintenance**: Preserve the `JobQueue` and 3-stage fallback sequence to maintain efficiency on low-RAM hosts.