# ðŸ¤– Gemini Context: local-nc-local-thumbnailer

## Project Overview
A Node.js worker that bridges the gap between a local FFmpeg installation and a remote Nextcloud instance.
**Version**: 1.0.1
**Repos**: https://github.com/hersche/local-nc-local-thumbnailer/ | https://github.com/hersche/nc-local-thumbnailer/

## Core Logic
-   **Directory Traversal**: Recursive scanning of WebDAV.
-   **Dual Queue Strategy (v1.0.1)**:
    -   `ioQueue`: Parallelizes downloads and API checks (Default: 2).
    -   `ffmpegQueue`: Strictly sequential (Concurrency: 1) for CPU-heavy `ffprobe` and `ffmpeg` tasks.
-   **3-Stage Generation Strategy**:
    1.  **Remote Stream**: Uses `ffprobe` (tuned) and `ffmpeg` screenshots via HTTP Range.
    2.  **Partial Download**: 100MB download.
    3.  **Full Fallback**: Up to `MAX_VIDEO_SIZE_MB`.

## Caching Strategy (mtime-aware)
1.  **Folder Cache**: Stores `mtime` (lastmod) of folders. Skips unchanged folders entirely.
2.  **Thumb Cache**: Tracks successfully processed relative paths.
3.  **Fail Cache**: Tracks failed files.

## Reliability & Performance
-   **Batch API**: Uses `batchExists` endpoint on NC-app side to reduce RTT.
-   **Security**: Supports `NC_STRICT_TLS` and `NC_SECRET`.
-   **Network**: Custom agents with Keep-Alive.

## Technical Tips for Gemini
-   **Environment**: `NC_SECRET` must match the server-side `api_secret`.
-   **DDEV**: Use `ddev php occ ...` for server-side operations in the test environment.